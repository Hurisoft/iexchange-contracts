# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk for trusted owners](#l-1-centralization-risk-for-trusted-owners)
  - [L-2: Solidity pragma should be specific, not wide](#l-2-solidity-pragma-should-be-specific-not-wide)
  - [L-3: Missing checks for `address(0)` when assigning values to address state variables](#l-3-missing-checks-for-address0-when-assigning-values-to-address-state-variables)
  - [L-4: Define and use `constant` variables instead of using literals](#l-4-define-and-use-constant-variables-instead-of-using-literals)
  - [L-5: Event is missing `indexed` fields](#l-5-event-is-missing-indexed-fields)
  - [L-6: Empty `require()` / `revert()` statements](#l-6-empty-require--revert-statements)
  - [L-7: The `nonReentrant` `modifier` should occur before all other modifiers](#l-7-the-nonreentrant-modifier-should-occur-before-all-other-modifiers)
  - [L-8: PUSH0 is not supported by all chains](#l-8-push0-is-not-supported-by-all-chains)
  - [L-9: Modifiers invoked only once can be shoe-horned into the function](#l-9-modifiers-invoked-only-once-can-be-shoe-horned-into-the-function)
  - [L-10: Internal functions called only once can be inlined](#l-10-internal-functions-called-only-once-can-be-inlined)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 11 |
| Total nSLOC | 1133 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| contracts/interfaces/IAMLBlacklist.sol | 9 |
| contracts/interfaces/IKYCWhitelist.sol | 17 |
| contracts/kycAML/AMLBlacklist.sol | 23 |
| contracts/kycAML/KYCWhitelist.sol | 33 |
| contracts/kycAML/OffchainAgent.sol | 25 |
| contracts/p2p/OptimisticP2p.sol | 615 |
| contracts/p2p/P2Pparams.sol | 358 |
| contracts/tokens/Cedih.sol | 7 |
| contracts/tokens/Ramp.sol | 7 |
| contracts/tokens/Troken.sol | 7 |
| contracts/utils/helpers.sol | 32 |
| **Total** | **1133** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 0 |
| Low | 10 |


# Low Issues

## L-1: Centralization Risk for trusted owners

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

- Found in contracts/kycAML/OffchainAgent.sol [Line: 13](contracts/kycAML/OffchainAgent.sol#L13)

	```solidity
	abstract contract OffchainAgent is Ownable, Helpers {
	```

- Found in contracts/kycAML/OffchainAgent.sol [Line: 28](contracts/kycAML/OffchainAgent.sol#L28)

	```solidity
	    function addAgent(address _agent) external onlyOwner {
	```

- Found in contracts/kycAML/OffchainAgent.sol [Line: 33](contracts/kycAML/OffchainAgent.sol#L33)

	```solidity
	    function removeAgent(address _agent) external onlyOwner {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 18](contracts/p2p/OptimisticP2p.sol#L18)

	```solidity
	contract OptimisticP2P is P2Pparams, Ownable, ReentrancyGuard, Helpers {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 47](contracts/p2p/OptimisticP2p.sol#L47)

	```solidity
	    function addToken(address token) external onlyOwner nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 54](contracts/p2p/OptimisticP2p.sol#L54)

	```solidity
	    ) external onlyOwner isTradeToken(token) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 61](contracts/p2p/OptimisticP2p.sol#L61)

	```solidity
	    ) external onlyOwner nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 68](contracts/p2p/OptimisticP2p.sol#L68)

	```solidity
	    ) external onlyOwner isSupportedPaymentMethod(_paymentMethod) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 75](contracts/p2p/OptimisticP2p.sol#L75)

	```solidity
	    ) external onlyOwner nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 82](contracts/p2p/OptimisticP2p.sol#L82)

	```solidity
	    ) external onlyOwner isSupportedCurrency(currency) nonReentrant {
	```



## L-2: Solidity pragma should be specific, not wide

Consider using a specific version of Solidity in your contracts instead of a wide version. For example, instead of `pragma solidity ^0.8.0;`, use `pragma solidity 0.8.0;`

- Found in contracts/interfaces/IAMLBlacklist.sol [Line: 2](contracts/interfaces/IAMLBlacklist.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/interfaces/IKYCWhitelist.sol [Line: 2](contracts/interfaces/IKYCWhitelist.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/kycAML/AMLBlacklist.sol [Line: 2](contracts/kycAML/AMLBlacklist.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/kycAML/KYCWhitelist.sol [Line: 2](contracts/kycAML/KYCWhitelist.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/kycAML/OffchainAgent.sol [Line: 2](contracts/kycAML/OffchainAgent.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 2](contracts/p2p/OptimisticP2p.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 2](contracts/p2p/P2Pparams.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/tokens/Cedih.sol [Line: 3](contracts/tokens/Cedih.sol#L3)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in contracts/tokens/Ramp.sol [Line: 3](contracts/tokens/Ramp.sol#L3)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in contracts/tokens/Troken.sol [Line: 3](contracts/tokens/Troken.sol#L3)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in contracts/utils/helpers.sol [Line: 2](contracts/utils/helpers.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```



## L-3: Missing checks for `address(0)` when assigning values to address state variables

Check for `address(0)` when assigning values to address state variables.

- Found in contracts/kycAML/AMLBlacklist.sol [Line: 21](contracts/kycAML/AMLBlacklist.sol#L21)

	```solidity
	        blacklist[_address] = Blacklist(_address, block.timestamp);
	```

- Found in contracts/kycAML/KYCWhitelist.sol [Line: 25](contracts/kycAML/KYCWhitelist.sol#L25)

	```solidity
	        addressKYCLevel[_address] = _level;
	```

- Found in contracts/kycAML/KYCWhitelist.sol [Line: 36](contracts/kycAML/KYCWhitelist.sol#L36)

	```solidity
	        addressKYCLevel[_address] = _level;
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 33](contracts/p2p/OptimisticP2p.sol#L33)

	```solidity
	        daoAddress = _daoAddress;
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 34](contracts/p2p/OptimisticP2p.sol#L34)

	```solidity
	        kycAddress = IKYCWhitelist(_kycAddress);
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 35](contracts/p2p/OptimisticP2p.sol#L35)

	```solidity
	        amlAddress = IAMLBlacklist(_amlAddress);
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 36](contracts/p2p/OptimisticP2p.sol#L36)

	```solidity
	        usdtAddress = IERC20Metadata(_usdtAddress);
	```



## L-4: Define and use `constant` variables instead of using literals

If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

- Found in contracts/utils/helpers.sol [Line: 28](contracts/utils/helpers.sol#L28)

	```solidity
	        require((value * bps) >= 10_000);
	```

- Found in contracts/utils/helpers.sol [Line: 29](contracts/utils/helpers.sol#L29)

	```solidity
	        return Math.mulDiv(value, bps, 10_000);
	```



## L-5: Event is missing `indexed` fields

Index event fields make the field more quickly accessible to off-chain tools that parse events. However, note that each index field costs extra gas during emission, so it's not necessarily best to index the maximum allowed per event (three fields). Each event should use three indexed fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three fields, all of the fields should be indexed.

- Found in contracts/interfaces/IAMLBlacklist.sol [Line: 11](contracts/interfaces/IAMLBlacklist.sol#L11)

	```solidity
	    event BlacklistAdded(address _address, address _agent);
	```

- Found in contracts/interfaces/IAMLBlacklist.sol [Line: 12](contracts/interfaces/IAMLBlacklist.sol#L12)

	```solidity
	    event BlacklistRemoved(address _address, address _agent);
	```

- Found in contracts/interfaces/IKYCWhitelist.sol [Line: 16](contracts/interfaces/IKYCWhitelist.sol#L16)

	```solidity
	    event KYCLevelUpgraded(address _address, address _agent, KYCLevel _level);
	```

- Found in contracts/interfaces/IKYCWhitelist.sol [Line: 17](contracts/interfaces/IKYCWhitelist.sol#L17)

	```solidity
	    event KYCLevelDowngraded(address _address, address _agent, KYCLevel _level);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 138](contracts/p2p/P2Pparams.sol#L138)

	```solidity
	    event OrderAccepted(uint256 indexed orderId, OrderState status);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 139](contracts/p2p/P2Pparams.sol#L139)

	```solidity
	    event OrderPaid(uint256 indexed orderId, OrderState status);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 140](contracts/p2p/P2Pparams.sol#L140)

	```solidity
	    event OrderReleased(uint256 indexed orderId, OrderState status);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 141](contracts/p2p/P2Pparams.sol#L141)

	```solidity
	    event OrderCancelled(uint256 indexed orderId, OrderState status);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 172](contracts/p2p/P2Pparams.sol#L172)

	```solidity
	    event DAOVoted(uint256 indexed appealId, AppealDecision daoVote);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 173](contracts/p2p/P2Pparams.sol#L173)

	```solidity
	    event PenaltySlashed(uint256 indexed appealId, address[] affected);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 174](contracts/p2p/P2Pparams.sol#L174)

	```solidity
	    event RewardDistributed(uint256 indexed appealId, address[] beneficiaries);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 179](contracts/p2p/P2Pparams.sol#L179)

	```solidity
	    event TokenAdded(address indexed _token, address _addedBy);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 180](contracts/p2p/P2Pparams.sol#L180)

	```solidity
	    event TokenRemoved(address indexed _token, address _addedBy);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 181](contracts/p2p/P2Pparams.sol#L181)

	```solidity
	    event PaymentMethodAdded(address _addedBy, string _method);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 182](contracts/p2p/P2Pparams.sol#L182)

	```solidity
	    event PaymentMethodRemoved(address _removedBy, string _method);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 183](contracts/p2p/P2Pparams.sol#L183)

	```solidity
	    event CurrencyAdded(address _addedBy, string _currency);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 184](contracts/p2p/P2Pparams.sol#L184)

	```solidity
	    event CurrencyRemoved(address _removedBy, string _currency);
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 185](contracts/p2p/P2Pparams.sol#L185)

	```solidity
	    event SettlerAssignedToCase(address _settler, uint256 _caseId);
	```



## L-6: Empty `require()` / `revert()` statements

Use descriptive reason strings or custom errors for revert paths.

- Found in contracts/p2p/P2Pparams.sol [Line: 308](contracts/p2p/P2Pparams.sol#L308)

	```solidity
	        require(msg.sender == order.trader || msg.sender == offer.merchant);
	```

- Found in contracts/utils/helpers.sol [Line: 28](contracts/utils/helpers.sol#L28)

	```solidity
	        require((value * bps) >= 10_000);
	```



## L-7: The `nonReentrant` `modifier` should occur before all other modifiers

This is a best-practice to protect against reentrancy in other modifiers.

- Found in contracts/p2p/OptimisticP2p.sol [Line: 47](contracts/p2p/OptimisticP2p.sol#L47)

	```solidity
	    function addToken(address token) external onlyOwner nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 54](contracts/p2p/OptimisticP2p.sol#L54)

	```solidity
	    ) external onlyOwner isTradeToken(token) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 61](contracts/p2p/OptimisticP2p.sol#L61)

	```solidity
	    ) external onlyOwner nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 68](contracts/p2p/OptimisticP2p.sol#L68)

	```solidity
	    ) external onlyOwner isSupportedPaymentMethod(_paymentMethod) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 75](contracts/p2p/OptimisticP2p.sol#L75)

	```solidity
	    ) external onlyOwner nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 82](contracts/p2p/OptimisticP2p.sol#L82)

	```solidity
	    ) external onlyOwner isSupportedCurrency(currency) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 99](contracts/p2p/OptimisticP2p.sol#L99)

	```solidity
	    function registerTrader() internal noBlacklisted nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 106](contracts/p2p/OptimisticP2p.sol#L106)

	```solidity
	    ) external noBlacklisted onlySettlers nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 119](contracts/p2p/OptimisticP2p.sol#L119)

	```solidity
	    function setterUnstake() external onlySettlers nonReentrant nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 128](contracts/p2p/OptimisticP2p.sol#L128)

	```solidity
	    ) external noBlacklisted onlyMerchants nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 145](contracts/p2p/OptimisticP2p.sol#L145)

	```solidity
	        nonReentrant
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 168](contracts/p2p/OptimisticP2p.sol#L168)

	```solidity
	        nonReentrant
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 210](contracts/p2p/OptimisticP2p.sol#L210)

	```solidity
	        nonReentrant
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 218](contracts/p2p/OptimisticP2p.sol#L218)

	```solidity
	    ) external onlyMerchants isOfferMerchant(offerId) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 235](contracts/p2p/OptimisticP2p.sol#L235)

	```solidity
	        nonReentrant
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 278](contracts/p2p/OptimisticP2p.sol#L278)

	```solidity
	    ) external isValidOrder(orderId) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 304](contracts/p2p/OptimisticP2p.sol#L304)

	```solidity
	    ) external isValidOrder(orderId) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 328](contracts/p2p/OptimisticP2p.sol#L328)

	```solidity
	    ) external isValidOrder(orderId) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 380](contracts/p2p/OptimisticP2p.sol#L380)

	```solidity
	    ) external isValidOrder(orderId) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 443](contracts/p2p/OptimisticP2p.sol#L443)

	```solidity
	    ) external isValidOrder(orderId) nonEmptyReason(reasonHash) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 509](contracts/p2p/OptimisticP2p.sol#L509)

	```solidity
	    ) external onlySettlers isValidAppeal(appealId) nonReentrant {
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 537](contracts/p2p/OptimisticP2p.sol#L537)

	```solidity
	        nonReentrant
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 577](contracts/p2p/OptimisticP2p.sol#L577)

	```solidity
	        nonReentrant
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 617](contracts/p2p/OptimisticP2p.sol#L617)

	```solidity
	        nonReentrant
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 645](contracts/p2p/OptimisticP2p.sol#L645)

	```solidity
	    ) external onlyDAO isValidVote(vote) isValidAppeal(appealId) nonReentrant {
	```



## L-8: PUSH0 is not supported by all chains

Solc compiler version 0.8.20 switches the default target EVM version to Shanghai, which means that the generated bytecode will include PUSH0 opcodes. Be sure to select the appropriate EVM version in case you intend to deploy on a chain other than mainnet like L2 chains that may not support PUSH0, otherwise deployment of your contracts will fail.

- Found in contracts/interfaces/IAMLBlacklist.sol [Line: 2](contracts/interfaces/IAMLBlacklist.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/interfaces/IKYCWhitelist.sol [Line: 2](contracts/interfaces/IKYCWhitelist.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/kycAML/AMLBlacklist.sol [Line: 2](contracts/kycAML/AMLBlacklist.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/kycAML/KYCWhitelist.sol [Line: 2](contracts/kycAML/KYCWhitelist.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/kycAML/OffchainAgent.sol [Line: 2](contracts/kycAML/OffchainAgent.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/p2p/OptimisticP2p.sol [Line: 2](contracts/p2p/OptimisticP2p.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 2](contracts/p2p/P2Pparams.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in contracts/tokens/Cedih.sol [Line: 3](contracts/tokens/Cedih.sol#L3)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in contracts/tokens/Ramp.sol [Line: 3](contracts/tokens/Ramp.sol#L3)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in contracts/tokens/Troken.sol [Line: 3](contracts/tokens/Troken.sol#L3)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in contracts/utils/helpers.sol [Line: 2](contracts/utils/helpers.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```



## L-9: Modifiers invoked only once can be shoe-horned into the function



- Found in contracts/p2p/P2Pparams.sol [Line: 221](contracts/p2p/P2Pparams.sol#L221)

	```solidity
	    modifier onlyTraders() {
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 249](contracts/p2p/P2Pparams.sol#L249)

	```solidity
	    modifier onlyDAO() {
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 263](contracts/p2p/P2Pparams.sol#L263)

	```solidity
	    modifier isSupportedCurrency(string memory _currency) {
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 270](contracts/p2p/P2Pparams.sol#L270)

	```solidity
	    modifier isSupportedPaymentMethod(string memory _paymentMethod) {
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 312](contracts/p2p/P2Pparams.sol#L312)

	```solidity
	    modifier validKYCLevel(IKYCWhitelist.KYCLevel _level) {
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 326](contracts/p2p/P2Pparams.sol#L326)

	```solidity
	    modifier nonEmptyReason(bytes32 _reasonHash) {
	```



## L-10: Internal functions called only once can be inlined

Instead of separating the logic into a separate function, consider inlining the logic into the calling function. This can reduce the number of function calls and improve readability.

- Found in contracts/p2p/P2Pparams.sol [Line: 343](contracts/p2p/P2Pparams.sol#L343)

	```solidity
	    function validateSettler(address settler) internal view {
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 369](contracts/p2p/P2Pparams.sol#L369)

	```solidity
	    function incrementMerchantOrders(address merchant) internal {
	```

- Found in contracts/p2p/P2Pparams.sol [Line: 380](contracts/p2p/P2Pparams.sol#L380)

	```solidity
	    function incrementSettlerSettlements(address settler) internal {
	```



